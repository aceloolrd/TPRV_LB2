#include <opencv2/opencv.hpp>
#include <omp.h>
#include <random>

using namespace cv;

// Функция для применения сверточного слоя с заданным ядром
Mat applyConvolution(const Mat& inputImage, const Mat& kernel) {
    Mat outputImage = inputImage.clone();
    int kernelRadius = kernel.rows / 2;

#pragma omp parallel for collapse(2) shared(inputImage, outputImage, kernel)
    for (int y = kernelRadius; y < inputImage.rows - kernelRadius; ++y) {
        for (int x = kernelRadius; x < inputImage.cols - kernelRadius; ++x) {
            // Применение свертки в текущем пикселе
            float sum = 0.0f;
            for (int ky = -kernelRadius; ky <= kernelRadius; ++ky) {
                for (int kx = -kernelRadius; kx <= kernelRadius; ++kx) {
                    sum += inputImage.at<uchar>(y + ky, x + kx) * kernel.at<float>(ky + kernelRadius, kx + kernelRadius);
                }
            }

            // Запись результата в выходное изображение
            outputImage.at<uchar>(y, x) = saturate_cast<uchar>(sum);
        }
    }

    return outputImage;
}

// Функция для генерации случайного ядра свертки в пределах от -0.5 до 0.5
Mat generateRandomKernel(int size) {
    Mat kernel(size, size, CV_32F);
    std::default_random_engine generator;
    std::uniform_real_distribution<float> distribution(-1, 1);

    for (int i = 0; i < size; ++i) {
        for (int j = 0; j < size; ++j) {
            kernel.at<float>(i, j) = distribution(generator);
        }
    }

    return kernel;
}

cv::Mat simpleGenerateRandomKernel(int size) {
    cv::Mat kernel(size, size, CV_32F);
    std::srand(static_cast<unsigned>(std::time(0)));  // Инициализация генератора случайных чисел

    // Генерация случайных чисел и заполнение матрицы
    for (int i = 0; i < size; ++i) {
        for (int j = 0; j < size; ++j) {
            kernel.at<float>(i, j) = static_cast<float>(std::rand()) / RAND_MAX - 0.5f;
        }
    }

    return kernel;
}

int main() {
    // Загрузка изображения с использованием OpenCV
    Mat inputImage = imread("test.png", IMREAD_GRAYSCALE);

    if (inputImage.empty()) {
        std::cerr << "Could not open or find the image!" << std::endl;
        return -1;
    }

    // Генерация случайного ядра свертки 3x3
    //Mat kernel = generateRandomKernel(3);
    Mat kernel = simpleGenerateRandomKernel(3);

    // Применение сверточного слоя
    Mat outputImage = applyConvolution(inputImage, kernel);

    // Вывод результатов
    namedWindow("Input Image", WINDOW_NORMAL);
    namedWindow("Output Image", WINDOW_NORMAL);

    imshow("Input Image", inputImage);
    imshow("Output Image", outputImage);

    waitKey(0);

    return 0;
}
